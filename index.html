<!DOCTYPE HTML>
<html>
<head>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="mystyle.css">
    <title>Assignment Tracking System V2.1</title>
</head>
<body>

<header class="main-header">
    <div class="logo-container">
        <img src="logo.png" alt="School Logo" class="school-logo">
    </div>

    <h1>Assignment Tracking System V2.1</h1>

    <button onclick="toggleDarkMode()" id="themeToggle">
        ðŸŒ™
    </button>
</header>

<section>
    <h3>Class Attendance</h3>
    <div id="headClassContainer"></div>
    <br>
    <input type="date" id="date" name="date">
    <label>
        <input type="checkbox" id="publicHolidayCheckbox"> Mark as Public Holiday
    </label>
    <br>
    <br>
    <button onclick="createAttendance()">Create New Attendance</button>
</section>
    <br>
<section>
    <h3>Create New Assignment</h3>

    <select id="classSelect"></select>
    <button onclick="goToClasses()">+ Create New Class</button>
    <input type="text" id="classWork" placeholder="Class Assignment Name (e.g. English Literature W1)">
    <input type="text" id="subjectName" placeholder="Subject (e.g. Mathematics)">
    <br><br>
    <button onclick="createAssignment()">Create new assignment</button>
</section>

<br>

<section>
    <button onclick="viewAssignment()">View Assignments</button>
    <button onclick="viewAttendance()">View Attendance</button>
</section>

<script>
function loadClassesDropdown() {
    const classes = JSON.parse(localStorage.getItem("classes")) || [];
    const select = document.getElementById("classSelect");

    select.innerHTML = "";

    if (classes.length === 0) {
        select.innerHTML = "<option value=''>No Classes Created</option>";
        return;
    }

    classes.forEach(c => {
        const option = document.createElement("option");
        option.value = c.id;
        option.textContent = c.name;
        select.appendChild(option);
    });
}

function createAttendance() {
    const headClassId = localStorage.getItem("headClassId");
    const date = document.getElementById("date").value;
    const isHoliday = document.getElementById("publicHolidayCheckbox").checked;

    if (!date) {
        alert("Please select a date.");
        return;
    }

    if (!headClassId) {
        alert("Please set head class first.");
        return;
    }

    // Load data for validation
    let attendanceRecords = JSON.parse(localStorage.getItem("attendance")) || [];
    let holidays = JSON.parse(localStorage.getItem("publicHolidays")) || [];

    // --- CASE 1: USER IS TRYING TO MARK A PUBLIC HOLIDAY ---
    if (isHoliday) {
        // Check if ANY class has attendance on this date
        const attendanceOnThisDate = attendanceRecords.some(a => a.date === date && !a.isPublicHoliday);
        
        if (attendanceOnThisDate) {
            alert("Cannot mark as Public Holiday: Attendance records already exist for this date.");
            return;
        }

        if (holidays.includes(date)) {
            alert("This date is already marked as a Public Holiday.");
            return;
        }

        // Save to Holiday list
        holidays.push(date);
        localStorage.setItem("publicHolidays", JSON.stringify(holidays));

        // Create a special record in attendance for visibility in viewAttendance.html
        const holidayRecord = {
            id: "hol_" + Date.now(),
            date: date,
            isPublicHoliday: true
        };
        attendanceRecords.push(holidayRecord);
        localStorage.setItem("attendance", JSON.stringify(attendanceRecords));

        alert("Public Holiday saved successfully.");
        location.reload(); // Refresh to clear inputs
        return;
    }

    // --- CASE 2: USER IS TRYING TO CREATE NORMAL ATTENDANCE ---
    // Check if the date is a holiday first
    if (holidays.includes(date)) {
        alert("Cannot create attendance: This date is a marked Public Holiday. Please delete the holiday first.");
        return;
    }

    const classes = JSON.parse(localStorage.getItem("classes")) || [];
    const selectedClass = classes.find(c => c.id === headClassId);

    // Check if attendance already exists for THIS class on this date
    const existing = attendanceRecords.find(a =>
        a.classId === headClassId && a.date === date
    );

    if (existing) {
        if (!confirm("Attendance already exists for this class on this date. Edit it?")) return;
        window.location.href = `attendance.html?id=${existing.id}`;
        return;
    }

    // If all checks pass, create the record
    const students = selectedClass.students.map(name => ({
        name,
        present: false,
        leftEarly: false,
        reason: ""
    }));

    const newAttendance = {
        id: "att_" + Date.now(),
        classId: headClassId,
        className: selectedClass.name,
        date,
        students,
        isPublicHoliday: false
    };

    attendanceRecords.push(newAttendance);
    localStorage.setItem("attendance", JSON.stringify(attendanceRecords));

    window.location.href = `attendance.html?id=${newAttendance.id}`;
}

function createAssignment() {
    const classId = document.getElementById("classSelect").value;
    const classWork = document.getElementById("classWork").value.trim();
    const subject = document.getElementById("subjectName").value.trim();

    if (!classId || !classWork || !subject) {
        alert("Please complete all fields");
        return;
    }

    const classes = JSON.parse(localStorage.getItem("classes")) || [];
    const selectedClass = classes.find(c => c.id === classId);

    const studentObjects = selectedClass.students.map(name => ({
        name,
        submitted: false
    }));

    const newAssignment = {
        id: "a_" + Date.now(),
        classId: selectedClass.id,
        className: selectedClass.name,
        title: classWork,
        subject,
        dateCreated: new Date().toLocaleDateString(),
        students: studentObjects
    };

    const assignments = JSON.parse(localStorage.getItem("assignments")) || [];
    assignments.push(newAssignment);
    localStorage.setItem("assignments", JSON.stringify(assignments));

    window.location.href = `assignment.html?id=${newAssignment.id}`;
}

function goToClasses() {
    window.location.href = "classes.html";
}

function viewAssignment() {
    window.location.href = "view.html";
}

function viewAttendance() {
    window.location.href = "viewAttendance.html";
}

function renderHeadClassUI() {
    const container = document.getElementById("headClassContainer");
    const classes = JSON.parse(localStorage.getItem("classes")) || [];
    const headClassId = localStorage.getItem("headClassId");

    container.innerHTML = "";

    // If no classes exist
    if (classes.length === 0) {
        container.innerHTML = `
            <button onclick="window.location.href='classes.html'">
                Create Class First
            </button>
        `;
        return;
    }

    // If no head class selected yet
    if (!headClassId) {
        container.innerHTML = `
            <select id="headClassSelect">
                <option value="">-- Select Attendance Class --</option>
                ${classes.map(c =>
                    `<option value="${c.id}">${c.name}</option>`
                ).join("")}
                <option value="new">+ Create New Class</option>
            </select>

            <button onclick="setHeadClassFromDropdown()">
                Set
            </button>
        `;
        return;
    }

    // If head class already selected
    const selected = classes.find(c => c.id === headClassId);

    if (!selected) {
        localStorage.removeItem("headClassId");
        renderHeadClassUI();
        return;
    }

    container.innerHTML = `
        <strong>${selected.name}</strong>
        <button onclick="changeHeadClass()" style="margin-left:10px;">
            Change
        </button>
    `;
}

function setHeadClassFromDropdown() {
    const select = document.getElementById("headClassSelect");
    const selectedValue = select.value;

    if (selectedValue === "new") {
        window.location.href = "classes.html";
        return;
    }

    if (!selectedValue) {
        alert("Please select a class.");
        return;
    }

    localStorage.setItem("headClassId", selectedValue);
    renderHeadClassUI();
}

function setHeadClass() {
    const classes = JSON.parse(localStorage.getItem("classes")) || [];

    if (classes.length === 0) {
        alert("No classes available. Please create a class first.");
        return;
    }

    const classNames = classes.map(c => c.name).join("\n");
    const selectedName = prompt("Enter the class name:\n\n" + classNames);

    const selectedClass = classes.find(c => c.name === selectedName);

    if (!selectedClass) {
        alert("Invalid class name.");
        return;
    }

    localStorage.setItem("headClassId", selectedClass.id);
    renderHeadClassUI();
}

function changeHeadClass() {
    const confirmChange = confirm(
        "Are you sure you want to change the attendance class?"
    );

    if (!confirmChange) return;

    localStorage.removeItem("headClassId");
    renderHeadClassUI();
}

function toggleDarkMode() {

    const body = document.body;

        if (body.classList.contains("dark")) {
            body.classList.remove("dark");
            body.classList.add("light");
            localStorage.setItem("theme", "light");
        } else {
            body.classList.remove("light");
            body.classList.add("dark");
            localStorage.setItem("theme", "dark");
        }
    }

function loadTheme() {
    const theme = localStorage.getItem("theme") || "light";
    document.body.classList.add(theme);
}

function setTodayDate() {
    const today = new Date().toLocaleDateString('en-CA');
    document.getElementById("date").value = today;
}

loadTheme();
loadClassesDropdown();
setTodayDate();
renderHeadClassUI();
</script>

</body>
</html>

