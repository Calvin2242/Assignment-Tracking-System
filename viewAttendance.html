<!DOCTYPE html>
<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link rel="stylesheet" href="mystyle.css">
<title>View Attendance</title>
</head>

<body>

<header>
    <h1>Attendance Records</h1>
    <button onclick="toggleDarkMode()" id="themeToggle">ðŸŒ™</button>
</header>

<section>

<input type="text" id="searchAttendance" placeholder="Search by date..."
oninput="renderAttendanceList()">

<br><br>
<label style="margin-left: 10px;">
    <input type="checkbox" id="hideHolidaysToggle" onchange="renderAttendanceList()" checked> 
    Show Public Holidays
</label>
<table id="attendanceTable">
<tr>
    <th>Date</th>
    <th>Class</th>
    <th>Present</th>
    <th>Actions</th>
</tr>
</table>

<br>

<button onclick="clearAttendanceData()" style="background:red;color:white;">
    Clear All Attendance Data
</button>

<button onclick="goHome()">Back to Home</button>

</section>

<script>

function renderAttendanceList() {
    const records = JSON.parse(localStorage.getItem("attendance")) || [];
    const search = document.getElementById("searchAttendance").value.toLowerCase();
    const showHolidays = document.getElementById("hideHolidaysToggle").checked; //
    const table = document.getElementById("attendanceTable");

    table.innerHTML = `
        <tr>
            <th>Date</th>
            <th>Class</th>
            <th>Present</th>
            <th>Actions</th>
        </tr>
    `;

    records
    .filter(r => r.date.includes(search))
    .filter(r => showHolidays || !r.isPublicHoliday) // Filter logic
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .forEach(record => {
        const row = table.insertRow();
        if (record.isPublicHoliday) {
            row.style.backgroundColor = "rgba(0, 123, 255, 0.1)";
            row.innerHTML = `
                <td><strong>${record.date}</strong></td>
                <td style="color: #007bff; font-weight: bold;">ðŸŽ‰ PUBLIC HOLIDAY</td>
                <td>â€”</td>
                <td><button onclick="deleteAttendance('${record.id}')" style="background:#dc3545; color:white;">Delete Holiday</button></td>
            `;
        } else {
            const presentCount = record.students.filter(s => s.present).length;
            row.innerHTML = `
                <td>${record.date}</td>
                <td>${record.className}</td>
                <td>${presentCount}/${record.students.length}</td>
                <td>
                    <button onclick="editAttendance('${record.id}')">Edit</button>
                    <button onclick="openParentReportModal('${record.id}')">Parent Weekly Report</button>
                    <button onclick="deleteAttendance('${record.id}')">Delete</button>
                </td>
            `;
        }
    });
}

function editAttendance(id){
    window.location.href = `attendance.html?id=${id}`;
}

function openReport(id){
    window.location.href = `attendanceReport.html?id=${id}`;
}

function deleteAttendance(id) {
    if (!confirm("Delete this record?")) return;

    let records = JSON.parse(localStorage.getItem("attendance")) || [];
    const recordToDelete = records.find(r => r.id === id);
    
    // If it's a holiday, remove it from the publicHolidays list too
    if (recordToDelete && recordToDelete.isPublicHoliday) {
        let holidays = JSON.parse(localStorage.getItem("publicHolidays")) || [];
        holidays = holidays.filter(h => h !== recordToDelete.date);
        localStorage.setItem("publicHolidays", JSON.stringify(holidays));
    }

    records = records.filter(r => r.id !== id);
    localStorage.setItem("attendance", JSON.stringify(records));
    renderAttendanceList();
}

function clearAttendanceData(){
    if(!confirm("This will delete ALL attendance records. Continue?")) return;
    localStorage.removeItem("attendance");
    renderAttendanceList();
}

// Function for Individual PDF Downloads
async function generateIndividualPDFs(studentNames) {
    const { jsPDF } = window.jspdf;
    const records = JSON.parse(localStorage.getItem("attendance")) || [];
    const record = selectedAttendanceRecord;
    const logoUrl = 'logo.png'; //

    const stats = calculateWeekStats(record, records);

    for (const studentName of studentNames) {
        const doc = createPDFDoc(jsPDF, studentName, record.className, stats, logoUrl);
        doc.save(`Weekly_Report_${studentName}.pdf`);
        // Small delay to prevent browser blocking multiple downloads
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    closeModal();
}

// Function for Single ZIP Download
async function generateZIPArchive(studentNames) {
    const { jsPDF } = window.jspdf;
    const zip = new JSZip(); //
    const records = JSON.parse(localStorage.getItem("attendance")) || [];
    const record = selectedAttendanceRecord;
    const logoUrl = 'logo.png'; //

    const stats = calculateWeekStats(record, records);

    for (const studentName of studentNames) {
        const doc = createPDFDoc(jsPDF, studentName, record.className, stats, logoUrl);
        const pdfOutput = doc.output("arraybuffer");
        zip.file(`Weekly_Report_${studentName}.pdf`, pdfOutput);
    }

    zip.generateAsync({ type: "blob" }).then(function(content) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(content);
        link.download = `Attendance_Reports_${stats.weekStartStr}.zip`;
        link.click();
    });
    closeModal();
}

// Helper: Calculate shared week data
function calculateWeekStats(record, records) {
    const recordDate = new Date(record.date);
    const todayStr = new Date().toLocaleDateString('en-CA'); // Results in YYYY-MM-DD
    
    // Calculate Monday for the selected record's week
    const startOfWeek = new Date(recordDate);
    startOfWeek.setDate(recordDate.getDate() - recordDate.getDay() + (recordDate.getDay() === 0 ? -6 : 1));
    
    const weekStartStr = startOfWeek.toISOString().split("T")[0];
    
    // Create an array of the 5 dates for that school week (Mon-Fri)
    const weekDates = [];
    for (let i = 0; i < 5; i++) {
        const d = new Date(startOfWeek);
        d.setDate(startOfWeek.getDate() + i);
        weekDates.push(d.toISOString().split("T")[0]);
    }

    const weekEndStr = weekDates[4];

    // Filter attendance records for this specific week
    const weeklyAttendanceRecords = records.filter(r => {
        return r.classId === record.classId && 
               r.date >= weekStartStr && 
               r.date <= weekEndStr && 
               !r.isPublicHoliday;
    });

    // MODIFICATION START:
    // 1. Find which of the 5 school days have actually occurred yet (up to today)
    const schoolDaysPassedSoFar = weekDates.filter(date => date <= todayStr);

    // 2. Count holidays that happened ONLY within those passed days
    const holidaysPassed = records.filter(r => {
        return r.date >= weekStartStr && 
               r.date <= todayStr && // Only count holidays up to today
               r.isPublicHoliday;
    });

    // 3. Subtract holidays from the days that have actually passed
    const totalSchoolDays = schoolDaysPassedSoFar.length - holidaysPassed.length;
    // MODIFICATION END

    return { 
        weekStartStr, 
        weekEndStr, 
        weeklyAttendanceRecords, 
        totalSchoolDays: totalSchoolDays > 0 ? totalSchoolDays : 0 
    };
}

// Helper: Shared PDF Layout Logic
function createPDFDoc(jsPDF, studentName, className, stats, logoUrl) {
    const doc = new jsPDF();
    const centerX = 105;
    let presentCount = 0;

    // Calculate presence based on weekly records
    stats.weeklyAttendanceRecords.forEach(r => {
        const s = r.students.find(st => st.name === studentName);
        if (s && s.present) presentCount++;
    });

    const absentCount = stats.totalSchoolDays - presentCount;
    const percentage = stats.totalSchoolDays === 0 ? 0 : ((presentCount / stats.totalSchoolDays) * 100).toFixed(1);
    
    // Set dynamic color based on performance
    let color = percentage < 80 ? [255, 0, 0] : (percentage < 90 ? [255, 165, 0] : [0, 128, 0]);

    // Draw Outer Border
    doc.setLineWidth(0.5);
    doc.rect(10, 10, 190, 277);

    // Header: Logo and Title
    try { doc.addImage(logoUrl, 'PNG', centerX - 15, 15, 30, 30); } catch (e) {}

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("WEEKLY ATTENDANCE REPORT", centerX, 55, { align: "center" });
    doc.line(30, 60, 180, 60);

    // Student Info
    doc.setFont("helvetica", "bold");
    doc.setFontSize(15);
    doc.text(`${studentName}`, centerX, 75, { align: "center" });
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text(`from ${className}`, centerX, 83, { align: "center" });
    const startFormatted = formatReportDate(stats.weekStartStr);
    const todayStr = new Date().toLocaleDateString('en-CA');
    const effectiveEndStr = stats.weekEndStr > todayStr ? todayStr : stats.weekEndStr;
    const endFormatted = formatReportDate(effectiveEndStr);
    const year = getYear(stats.weekEndStr);

    doc.setFont("helvetica", "bold");
    doc.text(`${startFormatted} â€” ${endFormatted} ${year}`, centerX, 91, { align: "center" });
    doc.line(60, 96, 150, 96);

    // Attendance Breakdown
    doc.setFontSize(14);
    doc.text(`Days Present: ${presentCount} / ${stats.totalSchoolDays}`, centerX, 115, { align: "center" });
    doc.text(`Days Absent: ${absentCount}`, centerX, 125, { align: "center" });

    // Percentage Indicator
    doc.setTextColor(...color);
    doc.setFontSize(24);
    doc.setFont("helvetica", "bold");
    doc.text(`${percentage}%`, centerX, 150, { align: "center" });
    
    doc.setFontSize(10);
    doc.text("Attendance Percentage", centerX, 158, { align: "center" });

    // Footer Disclaimer
    doc.setTextColor(150, 150, 150);
    doc.setFont("helvetica", "italic");
    doc.setFontSize(9);
    doc.text("This is an electronically generated report, hence does not require signature.", centerX, 280, { align: "center" });
    
    return doc;
}

function formatReportDate(dateStr) {
    const options = { day: 'numeric', month: 'short' };
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-GB', options); // Result: "16 Feb"
}

function getYear(dateStr) {
    return new Date(dateStr).getFullYear(); // Result: "2026"
}

function togglePublicHoliday(id){

    let records = JSON.parse(localStorage.getItem("attendance")) || [];
    const record = records.find(r => r.id === id);

    if(!record) return;

    record.publicHoliday = !record.publicHoliday;

    localStorage.setItem("attendance", JSON.stringify(records));

    alert(record.publicHoliday ?
        "Marked as Public Holiday." :
        "Removed Public Holiday status."
    );

    renderAttendanceList();
}

function generateSelectedReports() {
    const checkboxes = document.querySelectorAll('#studentCheckboxList input:checked');
    const selected = Array.from(checkboxes).map(cb => cb.value);
    
    if (selected.length === 0) {
        alert("Please select at least one student.");
        return;
    }
    // Reverted to individual downloads
    generateIndividualPDFs(selected); 
}

function openParentReportModal(id) {
    const records = JSON.parse(localStorage.getItem("attendance")) || [];
    selectedAttendanceRecord = records.find(r => r.id === id);

    if (!selectedAttendanceRecord) {
        alert("Record not found.");
        return;
    }

    const container = document.getElementById("studentCheckboxList");
    container.innerHTML = "";

    selectedAttendanceRecord.students.forEach(student => {
        container.innerHTML += `
            <div class="checkbox-item">
                <input type="checkbox" id="chk_${student.name}" value="${student.name}" checked>
                <label for="chk_${student.name}">${student.name}</label>
            </div>
        `;
    });

    document.getElementById("parentReportModal").style.display = "flex"; // Changed to flex for centering
}

function closeModal() {
    document.getElementById("parentReportModal").style.display = "none";
}

function goHome() {
    window.location.href = "index.html";
}

function toggleDarkMode() {
    const body = document.body;
    if (body.classList.contains("dark")) {
        body.classList.remove("dark");
        body.classList.add("light");
        localStorage.setItem("theme", "light");
    } else {
        body.classList.remove("light");
        body.classList.add("dark");
        localStorage.setItem("theme", "dark");
    }
}

function loadTheme() {
    const theme = localStorage.getItem("theme") || "light";
    document.body.classList.add(theme);
}

renderAttendanceList();
loadTheme();
</script>

<div id="parentReportModal" class="modal">
    <div class="modal-content">
        <h3>Select Students for Parent Report</h3>

        <div id="studentCheckboxList"></div>

        <br>

        <button onclick="generateSelectedReports()" style="background: #28a745; color: white;">Download Selected</button>
        <button onclick="generateAllReports()" style="background: #007bff; color: white;">Bulk Download All</button>
        <button onclick="closeModal()">Cancel</button>
    </div>
</div>

</body>
</html>
