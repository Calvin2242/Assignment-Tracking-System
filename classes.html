<!DOCTYPE HTML>
<html>
<head>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="mystyle.css?v=1">
<title>Manage Classes</title>
</head>

<body class="light">

<header>
    <div class="logo-container">
        <img src="logo.png" alt="School Logo" class="school-logo">
    </div>
    <h1>Class Management</h1>
    <button onclick="toggleDarkMode()" id="themeToggle">
        ðŸŒ™
    </button>
</header>

<section>
    <h3>Create New Class</h3>

    <input type="text" id="newClassName" placeholder="Class Name (e.g. 2 Mutiara)">
    <br><br>

    <label>
        Upload CSV
        <input style="appearance: auto;" type="radio" name="inputMethod" value="file" checked onclick="toggleInputMethod()">
    </label>
    <label>
        Manual Entry
        <input style="appearance: auto;" type="radio" name="inputMethod" value="manual" onclick="toggleInputMethod()">
    </label>
    <br><br>

    <div id="fileUploadSection">
        <input type="file" id="studentFile" accept=".csv">
        <button onclick="downloadSample()">Download CSV Sample</button>
    </div>

    <div id="manualEntrySection" style="display: none;">
        <p><small>Enter names (one per line):</small></p>
        <textarea id="manualStudentList" rows="5" placeholder="Ali&#10;Aisyah&#10;Daniel"></textarea>
    </div>

    <br>
    <button onclick="createClass()">Create Class</button>
</section>

<section>
    <h3>Existing Classes</h3>
    <ul id="classList"></ul>
</section>

<section>
    <button onclick="goHome()">Back</button>
</section>

<script>

function downloadSample() {
    const sample = "name\nAli\nAisyah\nDaniel";
    const blob = new Blob([sample], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "student_list_sample.csv";
    link.click();
}

function createClass() {
    const className = document.getElementById("newClassName").value.trim();
    const method = document.querySelector('input[name="inputMethod"]:checked').value;

    if (!className) {
        alert("Please enter class name.");
        return;
    }

    if (method === "file") {
        const fileInput = document.getElementById("studentFile");
        if (!fileInput.files[0]) {
            alert("Please upload student list.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split("\n").slice(1);
            const students = lines.map(line => line.trim()).filter(Boolean);
            
            // Execute your required saving method
            const newClass = {
                id: "c_" + Date.now(),
                name: className,
                students
            };

            const classes = JSON.parse(localStorage.getItem("classes")) || [];
            classes.push(newClass);
            localStorage.setItem("classes", JSON.stringify(classes));

            alert("Class created successfully!");
            location.reload();
        };
        reader.readAsText(fileInput.files[0]);

    } else {
        // Manual logic that mirrors your required saving method exactly
        const manualInput = document.getElementById("manualStudentList").value;
        const students = manualInput.split("\n").map(line => line.trim()).filter(Boolean);

        if (students.length === 0) {
            alert("Please enter at least one student name.");
            return;
        }

        const newClass = {
            id: "c_" + Date.now(),
            name: className,
            students
        };

        const classes = JSON.parse(localStorage.getItem("classes")) || [];
        classes.push(newClass);
        localStorage.setItem("classes", JSON.stringify(classes));

        alert("Class created successfully!");
        location.reload();
    }
}

function loadClasses() {
    const classes = JSON.parse(localStorage.getItem("classes")) || [];
    const list = document.getElementById("classList");
    list.innerHTML = "";

    classes.forEach(c => {
        const li = document.createElement("li");

        li.innerHTML = `
            <strong>${c.name}</strong> (${c.students.length} students)
            <br>
            <button onclick="editClass('${c.id}')">Edit</button>
            <button onclick="deleteClass('${c.id}')">Delete</button>
            <hr>
        `;

        list.appendChild(li);
    });
}

function deleteClass(id) {
    if (!confirm("Are you sure you want to delete this class?")) return;

    let classes = JSON.parse(localStorage.getItem("classes")) || [];
    classes = classes.filter(c => c.id !== id);
    localStorage.setItem("classes", JSON.stringify(classes));

    loadClasses();
}

let currentEditingClassId = null;

function editClass(id) {
    currentEditingClassId = id;
    const classes = JSON.parse(localStorage.getItem("classes")) || [];
    const selectedClass = classes.find(c => c.id === id);

    if (!selectedClass) return;

    // Fill the modal with current data
    document.getElementById("editClassName").value = selectedClass.name;
    renderModalStudentList(selectedClass.students);

    // Show the modal
    document.getElementById("editModal").style.display = "block";
    document.getElementById("modalOverlay").style.display = "block";
}

function renderModalStudentList(students) {
    const listDiv = document.getElementById("modalStudentList");
    listDiv.innerHTML = "";

    if (students.length === 0) {
        listDiv.innerHTML = "<p style='color:#888;'>No students in this class.</p>";
        return;
    }

    students.forEach((name, index) => {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.justifyContent = "space-between";
        row.style.alignItems = "center";
        row.style.padding = "5px 0";
        row.style.borderBottom = "1px solid #333";
        
        row.innerHTML = `
            <span>${name}</span>
            <button onclick="removeStudentFromEdit(${index})" style="background:#dc3545; color:white; border:none; padding:2px 8px; border-radius:3px; cursor:pointer;">Remove</button>
        `;
        listDiv.appendChild(row);
    });
}

function removeStudentFromEdit(index) {
    const classes = JSON.parse(localStorage.getItem("classes")) || [];
    const classIndex = classes.findIndex(c => c.id === currentEditingClassId);
    
    classes[classIndex].students.splice(index, 1);
    
    // Update the UI without closing the modal
    localStorage.setItem("classes", JSON.stringify(classes));
    renderModalStudentList(classes[classIndex].students);
}

function appendStudents() {
    const textarea = document.getElementById("addMoreStudentsNames");
    const newNames = textarea.value.split("\n").map(n => n.trim()).filter(Boolean);
    
    if (newNames.length === 0) return;

    const classes = JSON.parse(localStorage.getItem("classes")) || [];
    const classIndex = classes.findIndex(c => c.id === currentEditingClassId);
    
    // Merge existing students with new ones
    classes[classIndex].students = [...classes[classIndex].students, ...newNames];
    
    localStorage.setItem("classes", JSON.stringify(classes));
    textarea.value = ""; // Clear input
    renderModalStudentList(classes[classIndex].students);
}

function saveEditChanges() {
    const newClassName = document.getElementById("editClassName").value.trim();
    if (!newClassName) return alert("Class name cannot be empty.");

    const classes = JSON.parse(localStorage.getItem("classes")) || [];
    const classIndex = classes.findIndex(c => c.id === currentEditingClassId);
    
    classes[classIndex].name = newClassName;
    
    localStorage.setItem("classes", JSON.stringify(classes));
    alert("Changes saved!");
    location.reload(); // Refresh main list
}

function closeEditModal() {
    document.getElementById("editModal").style.display = "none";
    document.getElementById("modalOverlay").style.display = "none";
}

function goHome() {
    window.location.href = "index.html";
}

function toggleInputMethod() {
    const method = document.querySelector('input[name="inputMethod"]:checked').value;
    const fileSection = document.getElementById("fileUploadSection");
    const manualSection = document.getElementById("manualEntrySection");

    if (method === "file") {
        fileSection.style.display = "block";
        manualSection.style.display = "none";
    } else {
        fileSection.style.display = "none";
        manualSection.style.display = "block";
    }
}

function toggleDarkMode() {

    const body = document.body;

        if (body.classList.contains("dark")) {
            body.classList.remove("dark");
            body.classList.add("light");
            localStorage.setItem("theme", "light");
        } else {
            body.classList.remove("light");
            body.classList.add("dark");
            localStorage.setItem("theme", "dark");
        }
    }

    function loadTheme() {
        const theme = localStorage.getItem("theme") || "light";
        document.body.classList.add(theme);
    }

loadTheme();
loadClasses();
toggleInputMethod();
</script>

<div id="modalOverlay" onclick="closeEditModal()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999;"></div>

<div id="editModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#222; color:white; padding:20px; border-radius:10px; width:90%; max-width:500px; z-index:1000; max-height:80vh; overflow-y:auto; border:1px solid #444;">
    <h2 style="margin-top:0;">Class Details</h2>
    
    <label>Class Name:</label><br>
    <input type="text" id="editClassName" style="width:100%; margin-top:5px;">
    
    <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
    
    <h3>Students</h3>
    <div id="modalStudentList"></div>
    
    <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
    
    <h4>Add More Students</h4>
    <textarea id="addMoreStudentsNames" placeholder="Paste names here (one per line)" style="width:100%; height:60px;"></textarea>
    <button onclick="appendStudents()" style="background:#28a745; color:white; width:100%; margin-top:5px;">Add to List</button>

    <div style="margin-top:20px; display:flex; gap:10px;">
        <button onclick="saveEditChanges()" style="flex:1; background:#007bff; color:white;">Save All Changes</button>
        <button onclick="closeEditModal()" style="flex:1; background:#666; color:white;">Cancel</button>
    </div>
</div>

</body>
</html>

